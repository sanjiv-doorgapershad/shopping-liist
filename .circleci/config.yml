version: 2
jobs:
    prepare:
        docker:
            - image: circleci/node:10-browsers
        steps:
            - checkout
            - restore_cache:
                key: AngularCircleCI-v1.0-{{ .Branch }}-{{ checksum "package.json" }}
            - run: 
                name: install-npm
                command: npm install
            - save_cache:
                key: AngularCircleCI-v1.0-{{ .Branch }}-{{ checksum "package.json" }}
                paths:
                    - "node_modules"
                    - "platforms"
                    - "plugins"
    test:
        docker:
            - image: circleci/node:10-browsers
        steps:
            - checkout
            - restore_cache:
                key: AngularCircleCI-v1.0-{{ .Branch }}-{{ checksum "package.json" }}
            - run: 
                name: test
                command: npm run test-headless
            - store_artifacts:
                path: coverage
                prefix: coverage
    lint:
        docker:
            - image: circleci/node:10-browsers
        steps:
            - checkout
            - restore_cache:
                key: AngularCircleCI-v1.0-{{ .Branch }}-{{ checksum "package.json" }}
            - run: 
                name: lint
                command: npm run lint
    android:
        docker:
            - image: circleci/android:api-26-node8-alpha
                environment:
                    ANDROID_HOME: /opt/android/sdk
        steps:
            - checkout
            - restore_cache:
                keys: 
                    - AngularCircleCI-v1.0-{{ .Branch }}-{{ checksum "package.json" }}
                    #- ionic-platform-v1.0-{{ .Branch }}-{{ checksum "package.json" }}
            - run: 
                name: cordova
                command: sudo npm install -g ionic cordova
            - run:
                name: platform
                command: sudo ionic cordova platform add android
            - run:
                name: prepare
                command: npm run prepare-android
            - save_cache:
                key: ionic-platform-v1.0-{{ .Branch }}-{{ checksum "package.json" }}
                paths:
                    - "platforms"
                    - "plugins"
            - run:
                name: build
                command: sudo npm run release-android
            - store_artifacts:
                path: platforms/android/app/build/outputs/apk/release
workflows:
  version: 2
  build_and_test:
    jobs:
        #- prepare
        #- test:
        #    requires:
        #        - prepare
        #- lint:
        #    requires:
        #        - prepare
        - android
            
      
